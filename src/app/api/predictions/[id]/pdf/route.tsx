// src/app/api/predictions/[id]/pdf/route.tsx
import { NextRequest, NextResponse } from "next/server";
import { adminAuth, adminDb } from "@/lib/firebase-admin";
import { Document, Page, Text, View, StyleSheet, Font, Link as PdfLink } from "@react-pdf/renderer";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

Font.register({
  family: "Inter",
  fonts: [
    { src: "https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMa.woff2" },
  ],
});

const styles = StyleSheet.create({
  page: { padding: 32, fontFamily: "Inter" },
  title: { fontSize: 20, marginBottom: 12 },
  section: { marginBottom: 12 },
  label: { fontSize: 12, color: "#555" },
  value: { fontSize: 12, color: "#000" },
  reading: { fontSize: 12, color: "#111", lineHeight: 1.5, marginTop: 6, whiteSpace: "pre-wrap" as any },
  footer: { position: "absolute", bottom: 24, left: 32, right: 32, fontSize: 10, color: "#666" },
});

function ReadingPdf({
  userName,
  userEmail,
  query,
  prediction,
  createdAt,
}: {
  userName: string;
  userEmail: string;
  query: string;
  prediction: string;
  createdAt: string;
}) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <Text style={styles.title}>ðŸª” JyotAI Divine Reading</Text>

        <View style={styles.section}>
          <Text style={styles.label}>User</Text>
          <Text style={styles.value}>{userName} ({userEmail})</Text>
        </View>

        <View style={styles.section}>
          <Text style={styles.label}>Asked On</Text>
          <Text style={styles.value}>{createdAt}</Text>
        </View>

        <View style={styles.section}>
          <Text style={styles.label}>Question</Text>
          <Text style={styles.value}>{query}</Text>
        </View>

        <View style={styles.section}>
          <Text style={styles.label}>Reading</Text>
          <Text style={styles.reading}>{prediction}</Text>
        </View>

        <Text style={styles.footer}>
          Generated by JyotAI â€” jyoti.app
        </Text>
      </Page>
    </Document>
  );
}

/**
 * GET /api/predictions/:id/pdf
 */
export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = params.id;
    if (!id) return NextResponse.json({ error: "Missing prediction id" }, { status: 400 });

    const session = req.cookies.get("session")?.value;
    if (!session) return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

    const decoded = await adminAuth.verifySessionCookie(session, true);
    const uid = decoded.uid;

    const userRef = adminDb.collection("users").doc(uid);
    const [userSnap, predSnap] = await Promise.all([
      userRef.get(),
      userRef.collection("predictions").doc(id).get(),
    ]);

    if (!userSnap.exists) return NextResponse.json({ error: "User not found" }, { status: 404 });
    if (!predSnap.exists) return NextResponse.json({ error: "Prediction not found" }, { status: 404 });

    const user = userSnap.data() || {};
    const pred = predSnap.data() || {};

    const userName = (user.name as string) || "";
    const userEmail = (user.email as string) || "";
    const query = (pred.query as string) || "";
    const prediction = (pred.prediction as string) || "";
    const createdAtIso = (pred.createdAt as string) || "";
    const createdAt = createdAtIso ? new Date(createdAtIso).toLocaleString() : "";

    const { renderToStream } = await import("@react-pdf/renderer");
    const stream = await renderToStream(
      <ReadingPdf
        userName={userName}
        userEmail={userEmail}
        query={query}
        prediction={prediction}
        createdAt={createdAt}
      />
    );

    return new NextResponse(stream as unknown as ReadableStream, {
      status: 200,
      headers: {
        "Content-Type": "application/pdf",
        "Cache-Control": "no-store",
        "Content-Disposition": `inline; filename="jyotai-reading-${id}.pdf"`,
      },
    });
  } catch (e) {
    console.error("PDF error:", e);
    return NextResponse.json({ error: "Failed to generate PDF" }, { status: 500 });
  }
}
