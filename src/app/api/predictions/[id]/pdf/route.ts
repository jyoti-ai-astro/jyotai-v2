// src/app/api/predictions/[id]/pdf/route.ts
import { NextRequest, NextResponse } from "next/server";
import { adminAuth, adminDb } from "@/lib/firebase-admin";
import { Document, Page, Text, View, StyleSheet, pdf } from "@react-pdf/renderer";

export const runtime = "nodejs";

const styles = StyleSheet.create({
  page: {
    padding: 28,
    backgroundColor: "#0b1220",
    color: "#ffffff",
    fontSize: 12,
    lineHeight: 1.5,
  },
  title: { fontSize: 20, marginBottom: 10, color: "#D4AF37" },
  section: {
    marginTop: 10,
    paddingTop: 8,
    borderTopWidth: 1,
    borderTopColor: "#2b3244",
    borderTopStyle: "solid",
  },
  label: { color: "#a7b1c2", fontSize: 10, marginBottom: 4 },
  value: { color: "#ffffff", fontSize: 12, marginBottom: 6 },
  quote: {
    marginTop: 8,
    padding: 10,
    borderLeftWidth: 3,
    borderLeftColor: "#D4AF37",
    backgroundColor: "#121a2b",
  },
  footer: { marginTop: 24, fontSize: 9, color: "#9aa3b2" },
});

function PredictionPdf({
  name,
  email,
  dob,
  query,
  prediction,
  createdAt,
}: {
  name?: string;
  email?: string;
  dob?: string;
  query?: string;
  prediction?: string;
  createdAt?: string;
}) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <Text style={styles.title}>ðŸª” JyotAI Divine Reading</Text>

        <View style={styles.section}>
          <Text style={styles.label}>Seeker</Text>
          <Text style={styles.value}>{name || "â€”"}</Text>

          <Text style={styles.label}>Email</Text>
          <Text style={styles.value}>{email || "â€”"}</Text>

          <Text style={styles.label}>Date of Birth</Text>
          <Text style={styles.value}>{dob || "â€”"}</Text>

          <Text style={styles.label}>Question</Text>
          <Text style={styles.value}>{query || "â€”"}</Text>
        </View>

        <View style={styles.section}>
          <Text style={styles.label}>Divine Insight</Text>
          <View style={styles.quote}>
            <Text>{(prediction || "â€”").replace(/\r?\n/g, "\n")}</Text>
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.label}>Created</Text>
          <Text style={styles.value}>
            {createdAt
              ? new Date(createdAt).toLocaleString()
              : new Date().toLocaleString()}
          </Text>
        </View>

        <Text style={styles.footer}>
          Generated by Brahmin GPT Â· JyotAI â€” This reading is for personal
          guidance and reflection.
        </Text>
      </Page>
    </Document>
  );
}

export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = params.id;
    if (!id) {
      return NextResponse.json({ error: "Missing prediction id" }, { status: 400 });
    }

    const session = req.cookies.get("session")?.value;
    if (!session) {
      return NextResponse.json({ error: "Not authenticated" }, { status: 401 });
    }
    const decoded = await adminAuth.verifySessionCookie(session, true);
    const uid = decoded.uid;

    const userRef = adminDb.collection("users").doc(uid);
    const userSnap = await userRef.get();
    if (!userSnap.exists) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }
    const userData = userSnap.data() || {};
    const predSnap = await userRef.collection("predictions").doc(id).get();
    if (!predSnap.exists) {
      return NextResponse.json({ error: "Prediction not found" }, { status: 404 });
    }
    const pred = predSnap.data() || {};

    const instance = pdf(
      <PredictionPdf
        name={userData.name}
        email={userData.email}
        dob={pred.dob}
        query={pred.query}
        prediction={pred.prediction}
        createdAt={pred.createdAt}
      />
    );

    const pdfBuffer = await instance.toBuffer();

    return new NextResponse(pdfBuffer, {
      status: 200,
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition": `attachment; filename="jyotai-reading-${id}.pdf"`,
        "Cache-Control": "private, max-age=0, no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
      },
    });
  } catch (e) {
    console.error("PDF export error:", e);
    return NextResponse.json({ error: "Failed to generate PDF" }, { status: 500 });
  }
}
